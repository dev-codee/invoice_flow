<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}InvoiceFlow{% endblock %} — InvoiceFlow</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Design System -->
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/invoiceflow.css' %}">

  {% block extra_css %}{% endblock %}
</head>
<body>

{% if messages %}
<div class="toast-container">
  {% for message in messages %}
  <div class="toast-msg {{ message.tags }}" id="toast-{{ forloop.counter }}">
    <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill text-success
                 {% elif message.tags == 'error' %}bi-x-circle-fill text-danger
                 {% elif message.tags == 'warning' %}bi-exclamation-triangle-fill text-warning
                 {% else %}bi-info-circle-fill text-primary-color{% endif %}"></i>
    {{ message }}
    <button onclick="this.parentElement.remove()" style="margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;line-height:1;">×</button>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ═══════════ SIDEBAR ═══════════ -->
<aside class="sidebar" id="sidebar">
  <!-- Brand -->
  <div class="sidebar-brand">
    <div class="brand-text">Invoice<span>Flow</span></div>
    <div class="brand-tag">Billing · Invoices · Payments</div>
  </div>

  <!-- Navigation -->
  <nav class="sidebar-nav">
    <div class="sidebar-section-label">Main</div>

    <a href="{% url 'dashboard:dashboard' %}" class="{% if request.resolver_match.namespace == 'dashboard' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
      </svg>
      Dashboard
    </a>

    <a href="{% url 'clients:list' %}" class="{% if request.resolver_match.namespace == 'clients' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      Clients
    </a>

    <a href="{% url 'invoices:list' %}" class="{% if request.resolver_match.namespace == 'invoices' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
      </svg>
      Invoices
    </a>

    <a href="{% url 'recurring:list' %}" class="{% if request.resolver_match.namespace == 'recurring' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/>
        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15"/>
      </svg>
      Recurring
    </a>

    <div class="sidebar-section-label">Account</div>

    <a href="{% url 'notifications:list' %}" class="{% if request.resolver_match.namespace == 'notifications' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      Notifications
    </a>

    <a href="{% url 'organizations:settings' %}" class="{% if request.resolver_match.namespace == 'organizations' %}active{% endif %}">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M1 12h2M21 12h2M12 1v2M12 21v2"/>
      </svg>
      Settings
    </a>

    <a href="/api/docs/" target="_blank">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
      </svg>
      API Docs
    </a>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:8px 0;">

    <a href="{% url 'account_logout' %}" class="nav-signout">
      <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      Sign Out
    </a>
  </nav>

  <!-- User info at bottom -->
  <div class="sidebar-footer">
    <div class="sidebar-user">
      <div class="sidebar-avatar">{{ request.user.email|first|upper }}</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name">{{ request.user.get_full_name|default:request.user.username }}</div>
        <div class="sidebar-user-email">{{ request.user.email }}</div>
      </div>
    </div>
  </div>
</aside>

<!-- ═══════════ TOP BAR ═══════════ -->
<header class="topbar">
  <div style="display:flex;align-items:center;gap:12px;">
    <!-- Mobile menu toggle -->
    <button class="btn-icon" id="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')" style="display:none" title="Menu">
      <i class="bi bi-list"></i>
    </button>
    <div class="topbar-org-switcher">
      <button class="topbar-org-btn" onclick="document.getElementById('org-dropdown').classList.toggle('show')">
        <div class="org-avatar">{% if org %}{{ org.name|first|upper }}{% else %}I{% endif %}</div>
        <span class="org-name">{% if org %}{{ org.name }}{% else %}InvoiceFlow{% endif %}</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="org-dropdown" id="org-dropdown">
        <div class="dropdown-header">My Organizations</div>
        {% for membership in request.user.memberships.all %}
        <a href="{% url 'organizations:switch' membership.organization.id %}" class="dropdown-item {% if membership.organization == org %}active{% endif %}">
          <div class="org-avatar-sm">{{ membership.organization.name|first|upper }}</div>
          <div class="org-info">
            <div class="org-item-name">{{ membership.organization.name }}</div>
            <div class="org-item-role">{{ membership.get_role_display }}</div>
          </div>
          {% if membership.organization == org %}
          <i class="bi bi-check2 ms-auto"></i>
          {% endif %}
        </a>
        {% endfor %}
        <div class="dropdown-divider"></div>
        <a href="{% url 'organizations:create' %}" class="dropdown-item create-org-link">
          <i class="bi bi-plus-circle"></i>
          <span>Create New Organization</span>
        </a>
      </div>
    </div>
  </div>

  <div class="topbar-actions">
    <a href="{% url 'invoices:create' %}" class="btn btn-primary" style="padding:6px 14px;font-size:12.5px;">
      <i class="bi bi-plus"></i> New Invoice
    </a>
    <a href="{% url 'notifications:list' %}" class="btn-icon" title="Notifications">
      <i class="bi bi-bell"></i>
    </a>
    <a href="{% url 'organizations:settings' %}" class="topbar-user-btn">
      <div class="topbar-user-avatar">{{ request.user.email|first|upper }}</div>
      <span class="topbar-user-name">{{ request.user.email|truncatechars:22 }}</span>
      <i class="bi bi-chevron-down" style="font-size:10px;color:var(--text-muted);margin-left:2px;"></i>
    </a>
  </div>
</header>

<!-- ═══════════ MAIN CONTENT ═══════════ -->
<main class="main-content">
  <div class="page-container">
    {% block content %}{% endblock %}
  </div>
</main>

<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- Toast auto-dismiss -->
<script>
  document.querySelectorAll('.toast-msg').forEach(function(el) {
    setTimeout(function() {
      el.style.opacity = '0';
      el.style.transform = 'translateX(20px)';
      el.style.transition = 'all 0.3s ease';
      setTimeout(function() { el.remove(); }, 300);
    }, 4500);
  });

  // Organization switcher toggle
  window.addEventListener('click', function(e) {
    const switcher = document.querySelector('.topbar-org-switcher');
    const dropdown = document.getElementById('org-dropdown');
    if (switcher && !switcher.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });

  // Mobile sidebar toggle visibility
  if (window.innerWidth <= 1024) {
    document.getElementById('sidebar-toggle').style.display = 'flex';
  }
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
