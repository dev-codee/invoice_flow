<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice {{ invoice.invoice_number }} — {{ org.name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
    .portal-wrapper { max-width: 860px; margin: 40px auto; padding: 0 16px; }
    .portal-card { background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .portal-header { background: #1e1b4b; color: #fff; border-radius: 16px 16px 0 0; padding: 32px 40px; }
    .portal-body { padding: 40px; }
    .badge-paid { background:#d1fae5; color:#065f46; }
    .badge-overdue { background:#fee2e2; color:#991b1b; }
    .badge-sent, .badge-viewed { background:#dbeafe; color:#1d4ed8; }
    .badge-partially_paid { background:#fef3c7; color:#92400e; }
  </style>
</head>
<body>
<div class="portal-wrapper">
  <div class="portal-card">
    <div class="portal-header d-flex justify-content-between align-items-center">
      <div>
        <h3 class="fw-bold mb-1">{{ org.name }}</h3>
        {% if org.address %}<p class="mb-0 opacity-75 small">{{ org.address }}</p>{% endif %}
      </div>
      <div class="text-end">
        <div class="opacity-75 small">Invoice</div>
        <div class="h4 fw-bold mb-0">{{ invoice.invoice_number }}</div>
        <span class="badge badge-{{ invoice.status }} rounded-pill mt-1">{{ invoice.get_status_display }}</span>
      </div>
    </div>
    <div class="portal-body">
      {# Bill To / Dates #}
      <div class="row mb-4">
        <div class="col-6">
          <div class="text-muted small text-uppercase mb-1">Bill To</div>
          <div class="fw-bold">{{ invoice.client.name }}</div>
          <div class="text-muted">{{ invoice.client.email }}</div>
          {% if invoice.client.billing_address %}<small class="text-muted">{{ invoice.client.billing_address }}</small>{% endif %}
        </div>
        <div class="col-6 text-end">
          <div class="row g-1">
            <div class="col-6 text-muted small">Issue Date</div>
            <div class="col-6 fw-medium">{{ invoice.issue_date|date:"M d, Y" }}</div>
            <div class="col-6 text-muted small">Due Date</div>
            <div class="col-6 fw-medium {% if invoice.is_overdue %}text-danger{% endif %}">{{ invoice.due_date|date:"M d, Y" }}</div>
          </div>
        </div>
      </div>

      {# Line Items #}
      <div class="table-responsive mb-4">
        <table class="table">
          <thead class="table-light"><tr>
            <th>Description</th><th class="text-center">Qty</th>
            <th class="text-end">Price</th><th class="text-end">Tax</th><th class="text-end">Amount</th>
          </tr></thead>
          <tbody>
            {% for item in invoice.line_items.all %}
            <tr>
              <td>{{ item.description }}</td>
              <td class="text-center">{{ item.quantity }}</td>
              <td class="text-end">${{ item.unit_price|floatformat:2 }}</td>
              <td class="text-end">{{ item.tax_rate }}%</td>
              <td class="text-end fw-medium">${{ item.amount|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr><td colspan="4" class="text-end text-muted">Subtotal</td><td class="text-end">${{ invoice.subtotal|floatformat:2 }}</td></tr>
            {% if invoice.discount_amount %}<tr><td colspan="4" class="text-end text-muted">Discount</td><td class="text-end text-danger">-${{ invoice.discount_amount|floatformat:2 }}</td></tr>{% endif %}
            <tr><td colspan="4" class="text-end text-muted">Tax</td><td class="text-end">${{ invoice.tax_amount|floatformat:2 }}</td></tr>
            <tr class="fw-bold fs-5">
              <td colspan="4" class="text-end py-3" style="color:#1e1b4b">Total Due</td>
              <td class="text-end py-3" style="color:#1e1b4b">${{ invoice.total|floatformat:2 }}</td>
            </tr>
            {% if invoice.amount_paid %}
            <tr class="text-success"><td colspan="4" class="text-end fw-medium">Amount Paid</td><td class="text-end fw-bold">${{ invoice.amount_paid|floatformat:2 }}</td></tr>
            <tr><td colspan="4" class="text-end fw-bold text-danger">Balance Due</td><td class="text-end fw-bold text-danger">${{ invoice.balance_due|floatformat:2 }}</td></tr>
            {% endif %}
          </tfoot>
        </table>
      </div>

      {% if invoice.notes %}<p class="border-top pt-3 text-muted small"><b>Notes:</b> {{ invoice.notes }}</p>{% endif %}
      {% if invoice.terms %}<p class="text-muted small"><b>Terms:</b> {{ invoice.terms }}</p>{% endif %}

      {# Pay Now button #}
      {% if invoice.status not in 'paid,cancelled' and invoice.balance_due > 0 %}
      <div class="text-center mt-4 pt-4 border-top">
        <p class="text-muted small mb-3">Pay securely online with credit/debit card</p>
        <a href="/payments/invoice/{{ invoice.pk }}/stripe/" class="btn btn-success btn-lg px-5">
          <i class="bi bi-credit-card me-2"></i>Pay ${{ invoice.balance_due|floatformat:2 }} Now
        </a>
      </div>
      {% elif invoice.status == 'paid' %}
      <div class="text-center mt-4 py-4 border-top">
        <div class="text-success fw-bold fs-5"><i class="bi bi-check-circle-fill me-2"></i>Paid — Thank You!</div>
      </div>
      {% endif %}

      <div class="text-center mt-4">
        <small class="text-muted">Powered by InvoiceFlow</small>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
